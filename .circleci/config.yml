version: 2.1
orbs:
  android: circleci/android@2.2.0
  gradle: circleci/gradle@3.0.0



jobs:
  machine-build:
    parameters:
      resource-class:
        type: string
        default: "medium"
    machine:
      image: android:2023.09.1
    resource_class: << parameters.resource-class >>
    steps:
      - checkout
      - run: ./gradlew :module01:build
      - run: ./gradlew :module02:build
      - run: ./gradlew :module03:build
      - run: ./gradlew :module04:build
      - run: ./gradlew :module05:build
      - run: ./gradlew :module06:build
      - run: ./gradlew :module07:build
      - run: ./gradlew :module08:build
      - run: ./gradlew :module09:build
      - run: ./gradlew :module12:build
      - run: ./gradlew :module13:build
      - run: ./gradlew :module14:build
      - run: ./gradlew :module15:build
      - run: ./gradlew :module16:build
      - run: ./gradlew :module17:build
      - run: ./gradlew :module18:build
      - run: ./gradlew :module19:build
      - run: ./gradlew :module20:build
      - run: ./gradlew :module21:build
      - run: ./gradlew :module22:build
      - run: ./gradlew :module23:build
      - run: ./gradlew :module24:build
      - android/start-emulator-and-run-tests:
          pre-run-tests-steps:
            - run: echo "beginning tests"
          test-command: './gradlew clean'
          pre-emulator-wait-steps:
            - run: echo "waiting for emulator"
          post-emulator-wait-steps:
            - run: echo "emulator running"
          post-emulator-launch-assemble-command: './gradlew clean'
          post-run-tests-steps: 
            - run: echo "run test done"
            - run: mkdir testdata
            - run: adb pull storage .
          additional-avd-args: "-d pixel_3a -c 1G"
          additional-emulator-args: "-memory 4096 -cores 3 -writable-system"
          avd-name: 'testing'
          system-image: system-images;android-34;google_apis_playstore;x86_64

  docker-build:
    parameters:
      resource-class:
        type: string
        default: "medium"
    docker:
      - image: cimg/android:2023.09.1
    resource_class: << parameters.resource-class >>
    steps:
      - checkout
      - run: ./gradlew :module01:build
      - run: ./gradlew :module02:build
      - run: ./gradlew clean
      - run: ./gradlew :module03:build
      - run: ./gradlew :module04:build
      - run: ./gradlew clean
      - run: ./gradlew :module05:build
      - run: ./gradlew :module06:build
      - run: ./gradlew clean
      - run: ./gradlew :module07:build
      - run: ./gradlew :module08:build
      - run: ./gradlew clean
      - run: ./gradlew :module09:build
      - run: ./gradlew :module12:build
      - run: ./gradlew clean
      - run: ./gradlew :module13:build
      - run: ./gradlew :module14:build
      - run: ./gradlew clean
      - run: ./gradlew :module15:build
      - run: ./gradlew :module16:build
      - run: ./gradlew clean
      - run: ./gradlew :module17:build
      - run: ./gradlew :module18:build
      - run: ./gradlew clean
      - run: ./gradlew :module19:build
      - run: ./gradlew :module20:build
      - run: ./gradlew clean
      - run: ./gradlew :module21:build
      - run: ./gradlew :module22:build
      - run: ./gradlew clean
      - run: ./gradlew :module23:build
      - run: ./gradlew :module24:build
      - run: ./gradlew clean
      - android/start-emulator-and-run-tests:
          pre-run-tests-steps:
            - run: echo "beginning tests"
          test-command: './gradlew clean'
          pre-emulator-wait-steps:
            - run: echo "waiting for emulator"
          post-emulator-wait-steps:
            - run: echo "emulator running"
          post-emulator-launch-assemble-command: './gradlew clean'
          post-run-tests-steps: 
            - run: echo "run test done"
            - run: mkdir testdata
            - run: adb pull storage .
          additional-avd-args: "-d pixel_3a -c 1G"
          additional-emulator-args: "-memory 4096 -cores 3 -writable-system"
          avd-name: 'testing'
          system-image: system-images;android-34;google_apis_playstore;x86_64

workflows:
  docker-and-machine-build:
    jobs:
      - machine-build:
          matrix:
            parameters:
              resource-class: ["medium", "large", "xlarge", "2xlarge"]
      - docker-build:
          matrix:
            parameters:
              resource-class: ["small", "medium", "medium+", "large", "xlarge", "2xlarge"]